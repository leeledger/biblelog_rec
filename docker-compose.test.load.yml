# version 속성은 제거
services:
  frontend-test:
    container_name: bible_frontend_test
    image: frontend-src-backup-frontend-test:latest
    # 내부 네트워크에서만 접근 가능하도록 노출 (Nginx 프록시가 접근)
    expose:
      - "5173"
    environment:
      - NODE_ENV=test
      - VITE_API_BASE_URL=/api  # 상대 경로 사용 - Nginx 프록시가 처리
    depends_on:
      - backend-test
    networks:
      - test-network

  backend-test:
    container_name: bible_backend_test
    image: frontend-src-backup-backend-test:latest
    # 내부 네트워크에서만 접근 가능하도록 노출 (Nginx 프록시가 접근)
    expose:
      - "3001"
    environment:
      - NODE_ENV=test
      - PORT=3001
      - DATABASE_URL=postgresql://user:password@postgres-test:5432/bible_db_test
      # For direct pg client connection parameters if needed
      - PGHOST=postgres-test
      - PGUSER=user
      - PGPASSWORD=password
      - PGDATABASE=bible_db_test
      - PGPORT=5432
    depends_on:
      postgres-test:
        condition: service_healthy
    networks:
      - test-network

  postgres-test:
    container_name: bible_postgres_db_test
    image: postgres:13-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: bible_db_test
    # 내부 네트워크에서만 액세스 가능하도록 변경
    expose:
      - "5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d bible_db_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - test-network
      
  nginx-proxy:
    container_name: bible_nginx_proxy_test
    image: nginx:alpine
    ports:
      - "8443:443"  # HTTPS 포트
      - "8080:80"   # HTTP 포트 (리다이렉션용)
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - frontend-test
      - backend-test
    networks:
      - test-network

networks:
  test-network:
    driver: bridge

volumes:
  postgres_test_data: {} # Volume for PostgreSQL test data persistence